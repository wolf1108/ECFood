@model List<ECFood.Models.Recipes>
@{
    ViewBag.Title = "食譜管理";
}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div class="container mt-4">
    <h3 class="text-primary mb-4">
        <i class="bi bi-journal-text me-2"></i>食譜管理
    </h3>

    <!-- 搜尋與分類 -->
    <div class="row mb-3">
        <div class="col-md-6">
            <input type="text" id="searchInput" class="form-control" placeholder="搜尋食譜名稱或簡介...">
        </div>
        <div class="col-md-6 d-flex justify-content-end">
            <select id="categoryFilter" class="form-select w-auto">
                <option value="">所有分類</option>
                @foreach (var cat in ViewBag.Categories as List<SelectListItem>)
                {
                    <option value="@cat.Value">@cat.Text</option>
                }
            </select>
        </div>
    </div>

    <!-- 食譜表格 -->
    <table class="table table-bordered table-hover align-middle">
        <thead class="table-light text-center">
            <tr>
                <th>縮圖</th>
                <th>名稱</th>
                <th>難度</th>
                <th>分類</th>
                <th>時間</th>
                <th>狀態</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="recipeTable">
            @foreach (var recipe in Model)
            {
                var youtubeId = ViewBag.YoutubeIds[recipe.RecipeId];
                <tr>
                    <td class="text-center">
                        <img src="@(
    string.IsNullOrEmpty(recipe.ImageUrl)
        ? !string.IsNullOrEmpty(ViewBag.YoutubeIds[recipe.RecipeId])
            ? $" https://img.youtube.com/vi/{ViewBag.YoutubeIds[recipe.RecipeId]}/0.jpg"
                             : "/Images/default.jpg"
                             : recipe.ImageUrl
                             )" class="img-fluid rounded" style="width: 100px; height: 55px; object-fit: cover;" alt="@recipe.Title" />

                    </td>
                    <td>@recipe.Title</td>
                    <td class="text-center">@recipe.Difficulty</td>
                    <td class="text-center">@recipe.CategoryId</td>
                    <td class="text-center">@recipe.CookTime 分鐘</td>
                    <td class="text-center">
                        @if (recipe.IsPublished)
                        {
                            <span class="badge bg-success">已上架</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">未上架</span>
                        }
                    </td>
                    <td class="text-center">
                        <a class="btn btn-sm btn-info me-1" href="/Home/RecipeDetails/@recipe.RecipeId" target="_blank">
                            <i class="bi bi-eye"></i> 預覽
                        </a>
                        <button class="btn btn-sm btn-secondary me-1 toggle-publish-btn"
                                data-id="@recipe.RecipeId"
                                data-status="@(recipe.IsPublished.ToString().ToLower())">
                            <i class="bi bi-arrow-repeat"></i> @(recipe.IsPublished ? "下架" : "上架")
                        </button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="@recipe.RecipeId" data-title="@recipe.Title">
                            <i class="bi bi-trash"></i> 刪除
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<script>
    $(document).ready(function () {
        $("#searchInput, #categoryFilter").on("input change", function () {
            let keyword = $("#searchInput").val().toLowerCase();
            let cat = $("#categoryFilter").val();

            $("#recipeTable tr").filter(function () {
                let title = $(this).find("td:eq(1)").text().toLowerCase();
                let catVal = $(this).find("td:eq(3)").text();
                let match = title.includes(keyword);
                let catMatch = cat === "" || catVal === cat;
                $(this).toggle(match && catMatch);
            });
        });

        $(".delete-btn").click(function () {
            let id = $(this).data("id");
            let title = $(this).data("title");

            Swal.fire({
                title: `確定刪除「${title}」？`,
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "刪除",
                cancelButtonText: "取消"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/Home/AjaxDeleteRecipe',
                        type: 'POST',
                        data: { id: id },
                        success: function (res) {
                            if (res.success) {
                                location.reload();
                            } else {
                                Swal.fire("失敗", "刪除失敗，請稍後再試。", "error");
                            }
                        }
                    });
                }
            });
        });

        $(".toggle-publish-btn").click(function () {
            let id = $(this).data("id");
            let isPublished = $(this).data("status") === true || $(this).data("status") === "true";

            let action = isPublished ? "下架" : "上架";
            Swal.fire({
                title: `確定要${action}這筆食譜嗎？`,
                icon: "question",
                showCancelButton: true,
                confirmButtonText: action,
                cancelButtonText: "取消"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post("/Home/TogglePublish", { id: id }, function (res) {
                        if (res.success) {
                            location.reload();
                        } else {
                            Swal.fire("失敗", "操作失敗，請稍後再試。", "error");
                        }
                    });
                }
            });
        });
    });
</script>
